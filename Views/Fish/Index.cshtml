@model IEnumerable<Fish>

@{
    ViewData["Title"] = "Fish List";
}

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold" onclick="location.href='@Url.Action("Index", "Home")'">🐟 Fish Collection</h2>
        @if (Context.Session.GetString("UserRole") == "Admin")
        {
            <a asp-action="Create" class="btn btn-warning px-4">
                + Add Fish
            </a>
            @Html.AntiForgeryToken()
        }
        
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">
            No fish available. Add your first fish 🐠
        </div>
    }
    else
    {
        <!-- Desktop Grid View -->
        <div class="row g-4 d-none d-md-flex">
            @foreach (var fish in Model)
            {
                <div class="col-12 col-sm-6 col-md-6 col-lg-4 animate-fade-in-up">
                    <div class="card shadow-sm h-100 border-0 rounded-4 fish-card">

                        <!-- Image -->
                        <div class="overflow-hidden rounded-top-4">
                             <img src="@(string.IsNullOrEmpty(fish.ImagePath)
                                                                 ? "/images/no-image.png"
                                                                 : fish.ImagePath)"
                                  class="card-img-top"
                                  style="height:250px; object-fit:cover; width:100%;" />
                        </div>

                        <div class="card-body d-flex flex-column">

                            <h5 class="card-title fw-bold text-dark">
                                @fish.FishName
                            </h5>

                            <!-- Description Preview -->
                            <p class="card-text text-muted small">
                        @{
                                    var desc = fish.Description ?? "";
                                    if (desc.Length > 90)
                                    {
                                        @desc.Substring(0, 90)
                        
                                        <text>...</text>
                                    }
                                    else
                                    {
                                        @desc
                                    }
                                }
                            </p>

                            <!-- Price -->
                            <div class="mt-auto d-flex justify-content-between align-items-center">
                                <span class="badge bg-primary bg-gradient fs-6 px-3 py-2 rounded-pill">
                                    AED @fish.Price.ToString("N2")
                                </span>

                                <div class="btn-group">
                                    <a asp-action="Details"
                                       asp-route-id="@fish.Id"
                                       class="btn btn-outline-info btn-sm rounded-pill me-1">
                                        <i class="fas fa-eye"></i>
                                    </a>

                                    @if (Context.Session.GetString("UserRole") == "Admin")
                                    {
                                        <a asp-action="Edit"
                                           asp-route-id="@fish.Id"
                                           class="btn btn-outline-warning btn-sm rounded-pill me-1">
                                            <i class="fas fa-edit"></i>
                                        </a>

                                        <a href="javascript:void(0);" 
                                           onclick="confirmDelete(@fish.Id)"
                                           class="btn btn-outline-danger btn-sm rounded-pill">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    }
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Mobile Accordion View -->
        <div class="accordion d-md-none" id="fishAccordion">
            @foreach (var fish in Model)
            {
                <div class="accordion-item border-0 mb-2 shadow-sm rounded-3 overflow-hidden">
                    <h2 class="accordion-header" id="heading-@fish.Id">
                        <button class="accordion-button collapsed fw-bold text-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@fish.Id" aria-expanded="false" aria-controls="collapse-@fish.Id">
                            <span class="me-2">🐠</span> @fish.FishName 
                            <span class="ms-auto badge bg-light text-dark border">AED @fish.Price.ToString("N0")</span>
                        </button>
                    </h2>
                    <div id="collapse-@fish.Id" class="accordion-collapse collapse" aria-labelledby="heading-@fish.Id" data-bs-parent="#fishAccordion">
                        <div class="accordion-body bg-white">
                            <div class="text-center mb-3">
                                <img src="@(string.IsNullOrEmpty(fish.ImagePath) ? "/images/no-image.png" : fish.ImagePath)" 
                                     class="img-fluid rounded-3 shadow-sm" style="max-height: 200px;" />
                            </div>
                            <p class="small text-muted">@fish.Description</p>
                            <div class="d-flex justify-content-end gap-2">
                                <a asp-action="Details" asp-route-id="@fish.Id" class="btn btn-sm btn-info text-white rounded-pill">View</a>
                                @if (Context.Session.GetString("UserRole") == "Admin")
                                {
                                    <a asp-action="Edit" asp-route-id="@fish.Id" class="btn btn-sm btn-warning text-white rounded-pill">Edit</a>
                                    <a href="javascript:void(0);" onclick="confirmDelete(@fish.Id)" class="btn btn-sm btn-danger rounded-pill">Delete</a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    @section Scripts {
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            function confirmDelete(id) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Create and submit a form programmatically
                        var form = document.createElement('form');
                        form.method = 'post';
                        form.action = '/Fish/Delete/' + id;
                        
                        // Add AntiForgeryToken if needed (usually handled by cookies/headers or hidden input in layout)
                        // For simplicity, we assume standard routing works.
                        // Ideally we should grab the verification token.
                        // Let's rely on the text-based form submission which MVC handles well.
                        
                        var tokenInput = document.createElement('input');
                        tokenInput.type = 'hidden';
                        tokenInput.name = '__RequestVerificationToken';
                        tokenInput.value = $('input[name="__RequestVerificationToken"]').val();
                        form.appendChild(tokenInput);

                        document.body.appendChild(form);
                        form.submit();
                    }
                })
            }
        </script>
    }
</div>
